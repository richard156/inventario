<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario - Visualizaci√≥n</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #4CAF50; color: white; }
        img.thumbnail { max-width: 80px; max-height: 80px; border-radius: 5px; }
        #auth-section { padding: 15px; background: #e8f5e9; border-radius: 5px; margin: 20px 0; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #authorize_button { background: #4285f4; color: white; }
        #signout_button { background: #db4437; color: white; }
        .fragile { background-color: #fff3cd; }
        .loading { color: #666; font-style: italic; }
        .error { color: #d32f2f; background: #ffebee; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .success { color: #388e3c; background: #e8f5e9; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ Visualizaci√≥n de Inventario</h1>
        <p>Datos obtenidos de Google Sheets en tiempo real.</p>

        <div id="auth-section">
            <button id="authorize_button" style="display:none;">üîë Iniciar Sesi√≥n con Google</button>
            <button id="signout_button" style="display:none;">üö™ Cerrar Sesi√≥n</button>
            <span id="auth-status" class="loading">Esperando autenticaci√≥n...</span>
        </div>

        <div id="debug-info" class="error" style="display:none;"></div>

        <div id="loading" style="display:none;">
            <div class="loading">‚è≥ Cargando datos desde Google Sheets...</div>
            <div style="margin-top:10px; color:#666;">
                <small>Esto puede tomar unos segundos. Verifica la consola (F12) si tarda mucho.</small>
            </div>
        </div>

        <div id="table-container"></div>
    </div>

    <script>
        // ============================================
        // üîê CONFIGURACI√ìN - REEMPLAZA CON TUS DATOS
        // ============================================
        // ‚ùó OBT√âN UNA NUEVA API_KEY EN: https://console.cloud.google.com
        const API_KEY = 'AIzaSyDwR2gcdFzYC3Lbt_o6kUtjQ9lN8dutnog'; // 40 caracteres, ej: AIzaSyB8i2oPNqfxO-8kEyOMGo3LY9sekPKT4fg
        const CLIENT_ID = '386513901927-vcogv19hqgiqukdt885fik8spppri27v.apps.googleusercontent.com';
        const SPREADSHEET_ID = '14Biamc2q1cvNegVz4pj0yfspWOoA1rf4';

        const HOJA_NOMBRE = 'Data';
        const RANGO = `${HOJA_NOMBRE}!A2:M`;

        // URL para im√°genes en GitHub Pages
        const URL_BASE_IMAGENES = 'https://richard156.github.io/inventario/scanpet/PHOTOS_salida_20260123_1452/';

        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';

        // ============================================
        // üöÄ INICIALIZACI√ìN
        // ============================================
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        function showDebug(message, isError = true) {
            const debugDiv = document.getElementById('debug-info');
            debugDiv.innerHTML = isError ? `‚ùå ${message}` : `‚ÑπÔ∏è ${message}`;
            debugDiv.className = isError ? 'error' : 'success';
            debugDiv.style.display = 'block';
            console.log(isError ? 'Error:' : 'Info:', message);
        }

        function hideDebug() {
            document.getElementById('debug-info').style.display = 'none';
        }

        function updateAuthStatus(message, isSuccess = false) {
            const statusEl = document.getElementById('auth-status');
            statusEl.textContent = message;
            statusEl.className = isSuccess ? 'success' : 'loading';
        }

        async function gapiLoaded() {
            try {
                await gapi.load('client', initializeGapiClient);
                console.log('‚úÖ gapi.load completado');
            } catch (error) {
                showDebug(`Error cargando gapi: ${error.message}`);
            }
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                });
                gapiInited = true;
                console.log('‚úÖ Google API inicializada');
                maybeEnableAuthButton();
            } catch (error) {
                showDebug(`Error inicializando API: ${error.message}`);
                if (error.message.includes('API key')) {
                    showDebug('Tu API_KEY es inv√°lida. Ve a https://console.cloud.google.com y crea una nueva clave de 40 caracteres.');
                }
            }
        }

        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: '',
                });
                gisInited = true;
                console.log('‚úÖ Google Identity Services inicializado');
                maybeEnableAuthButton();
            } catch (error) {
                showDebug(`Error GIS: ${error.message}`);
            }
        }

        function maybeEnableAuthButton() {
            if (gapiInited && gisInited) {
                document.getElementById('authorize_button').style.display = 'inline-block';
                updateAuthStatus('Listo para autenticar. Haz clic en "Iniciar Sesi√≥n".');
                console.log('‚úÖ Bot√≥n de autorizaci√≥n habilitado');
            }
        }

        // ============================================
        // üîë AUTENTICACI√ìN
        // ============================================
        document.getElementById('authorize_button').onclick = () => {
            console.log('Iniciando autenticaci√≥n OAuth...');
            updateAuthStatus('Redirigiendo a Google para autenticaci√≥n...');
            
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error('Error OAuth:', resp);
                    updateAuthStatus('Error de autenticaci√≥n');
                    showDebug(`Error OAuth: ${resp.error}. Verifica tu CLIENT_ID y configuraci√≥n en Google Cloud.`);
                    return;
                }
                
                document.getElementById('authorize_button').style.display = 'none';
                document.getElementById('signout_button').style.display = 'inline-block';
                updateAuthStatus('‚úÖ Autenticado correctamente', true);
                hideDebug();
                await cargarYMostrarDatos();
            };
            
            tokenClient.requestAccessToken({ prompt: 'consent' });
        };

        document.getElementById('signout_button').onclick = () => {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken(null);
                document.getElementById('table-container').innerHTML = '';
                document.getElementById('signout_button').style.display = 'none';
                document.getElementById('authorize_button').style.display = 'inline-block';
                updateAuthStatus('Sesi√≥n cerrada. Vuelve a iniciar sesi√≥n.');
                document.getElementById('loading').style.display = 'none';
            }
        };

        // ============================================
        // üìä CARGAR DATOS
        // ============================================
        async function cargarYMostrarDatos() {
            const contenedor = document.getElementById('table-container');
            const loading = document.getElementById('loading');

            loading.style.display = 'block';
            contenedor.innerHTML = '';
            hideDebug();

            try {
                console.log('Solicitando datos...');
                updateAuthStatus('Obteniendo datos de Google Sheets...', true);

                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: RANGO,
                });

                console.log('Respuesta recibida:', response);

                const filas = response.result.values;
                if (!filas || filas.length === 0) {
                    contenedor.innerHTML = '<p class="loading">No se encontraron datos en la hoja.</p>';
                    return;
                }

                // Mostrar datos
                const COLUMNAS = {
                    CODIGO: 0, ARTICULO: 1, UNIDADES: 2, COMENTARIO: 3,
                    UBICACION: 4, PRECIO: 5, FRAGIL: 6, FOTO: 7,
                    FECHA: 8, HORA: 9, LATITUD: 10, LONGITUD: 11, VENTA: 12
                };

                let html = `
                    <div class="success">
                        ‚úÖ <strong>${filas.length} items cargados</strong> - ${new Date().toLocaleTimeString()}
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>C√≥digo</th><th>Art√≠culo</th><th>Unid.</th>
                                <th>Ubicaci√≥n</th><th>Precio</th><th>Fr√°gil</th>
                                <th>Foto</th><th>Fecha</th><th>Comentario</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                filas.forEach((fila, index) => {
                    const nombreFoto = fila[COLUMNAS.FOTO];
                    const urlFoto = nombreFoto ? `${URL_BASE_IMAGENES}${nombreFoto.trim()}` : '';
                    const esFragil = fila[COLUMNAS.FRAGIL]?.toUpperCase() === 'SI' ? 'fragile' : '';

                    html += `
                        <tr class="${esFragil}">
                            <td><code>${fila[COLUMNAS.CODIGO] || ''}</code></td>
                            <td><strong>${fila[COLUMNAS.ARTICULO] || ''}</strong></td>
                            <td>${fila[COLUMNAS.UNIDADES] || '1'}</td>
                            <td>${fila[COLUMNAS.UBICACION] || ''}</td>
                            <td>${formatearPrecio(fila[COLUMNAS.PRECIO])}</td>
                            <td>${fila[COLUMNAS.FRAGIL] || 'No'}</td>
                            <td>${urlFoto ? 
                                `<img src="${urlFoto}" alt="Foto" class="thumbnail" 
                                     onerror="this.style.display='none'; console.log('Error cargando: ${nombreFoto}')">` 
                                : '‚Äî'}</td>
                            <td>${formatearFecha(fila[COLUMNAS.FECHA])}</td>
                            <td>${fila[COLUMNAS.COMENTARIO] || ''}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                contenedor.innerHTML = html;
                updateAuthStatus(`‚úÖ ${filas.length} items cargados correctamente`, true);

            } catch (error) {
                console.error('Error completo:', error);
                
                let mensaje = `Error: ${error.message}`;
                if (error.status === 403) {
                    mensaje = 'Acceso denegado (403). Verifica:<br>' +
                              '1. La hoja est√° compartida como "Cualquier persona con el enlace"<br>' +
                              '2. Tu API_KEY tiene acceso a Google Sheets API<br>' +
                              '3. Tu CLIENT_ID est√° configurado correctamente';
                } else if (error.status === 404) {
                    mensaje = 'Hoja no encontrada (404). Verifica:<br>' +
                              '1. SPREADSHEET_ID es correcto<br>' +
                              '2. La hoja "Data" existe en el documento';
                } else if (error.message.includes('API key')) {
                    mensaje = 'API_KEY inv√°lida. Ve a Google Cloud Console y crea una nueva clave.';
                }
                
                showDebug(mensaje);
                updateAuthStatus('Error cargando datos');
            } finally {
                loading.style.display = 'none';
            }
        }

        function formatearPrecio(valor) {
            if (!valor) return '‚Äî';
            const numero = parseFloat(valor);
            return isNaN(numero) ? valor : `$${numero.toLocaleString('es-ES')}`;
        }

        function formatearFecha(valor) {
            if (!valor) return '‚Äî';
            const fecha = new Date(valor);
            return isNaN(fecha.getTime()) ? valor : fecha.toLocaleDateString('es-ES');
        }

        // ============================================
        // üèÅ INICIALIZAR
        // ============================================
        window.gapiLoaded = gapiLoaded;
        window.gisLoaded = gisLoaded;

        // Verificar configuraci√≥n inicial
        console.log('=== CONFIGURACI√ìN ACTUAL ===');
        console.log('API_KEY:', API_KEY ? 'Configurada (' + API_KEY.length + ' chars)' : 'NO CONFIGURADA');
        console.log('CLIENT_ID:', CLIENT_ID ? 'Configurado' : 'NO CONFIGURADO');
        console.log('SPREADSHEET_ID:', SPREADSHEET_ID);
        console.log('URL im√°genes:', URL_BASE_IMAGENES);
        console.log('======================');

        if (!API_KEY || API_KEY.includes('TU_NUEVA_API_KEY_AQUI')) {
            showDebug('‚ùå API_KEY NO CONFIGURADA. Reemplaza "TU_NUEVA_API_KEY_AQUI" con tu clave real de Google Cloud.');
        }
    </script>
</body>
</html>
