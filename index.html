<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario - Visualizaci√≥n</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        img.thumbnail { max-width: 100px; max-height: 100px; }
        #auth-section, #loading, #table-container { margin: 20px 0; }
        .fragile { background-color: #fff3cd; }
        .error { color: red; background: #ffe6e6; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üì¶ Visualizaci√≥n de Inventario</h1>
    <p>Datos obtenidos de Google Sheets en tiempo real.</p>

    <div id="auth-section">
        <button id="authorize_button" style="display:none;">üîë Iniciar Sesi√≥n con Google</button>
        <button id="signout_button" style="display:none;">üö™ Cerrar Sesi√≥n</button>
        <span id="auth-status"></span>
    </div>

    <div id="loading" style="display:none;">‚è≥ Cargando datos desde Google Sheets...</div>
    <div id="debug-info" class="error" style="display:none;"></div>
    <div id="table-container"></div>

    <script>
        // ============================================
        // üîê CONFIGURACI√ìN
        // ============================================
        // ‚ùó REEMPLAZA ESTOS VALORES CON LOS REALES
        const API_KEY = 'AIzaSyDwR2gcdFzYC3Lbt_o6kUtjQ9lN8dutnog'; // Ej: 'AIzaSyB8i2oPNqfxO-8kEyOMGo3LY9sekPKT4fg'
        const CLIENT_ID = '386513901927-vcogv19hqgiqukdt885fik8spppri27v.apps.googleusercontent.com';
        const SPREADSHEET_ID = '14Biamc2q1cvNegVz4pj0yfspWOoA1rf4';

        const HOJA_NOMBRE = 'Data';
        const RANGO = `${HOJA_NOMBRE}!A2:M`;

        // Si las im√°genes est√°n en tu repositorio GitHub Pages:
        const URL_BASE_IMAGENES = 'https://richard156.github.io/scanpet/PHOTOS_salida_20260123_1452/';

        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';

        // ============================================
        // üöÄ INICIALIZACI√ìN CORREGIDA
        // ============================================
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    // ‚úÖ ESTA L√çNEA ES CR√çTICA:
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                });
                gapiInited = true;
                maybeEnableAuthButton();
                console.log('‚úÖ Google API inicializada correctamente');
            } catch (error) {
                console.error('‚ùå Error inicializando Google API:', error);
                showError(`Error de API: ${error.message}`);
            }
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableAuthButton();
            console.log('‚úÖ Google Identity Services inicializado');
        }

        function maybeEnableAuthButton() {
            if (gapiInited && gisInited) {
                document.getElementById('authorize_button').style.display = 'inline-block';
                console.log('‚úÖ Bot√≥n de autorizaci√≥n habilitado');
            }
        }

        function showError(message) {
            const debugDiv = document.getElementById('debug-info');
            debugDiv.innerHTML = `‚ùå ERROR: ${message}`;
            debugDiv.style.display = 'block';
        }

        // ============================================
        // üîë MANEJO DE AUTENTICACI√ìN
        // ============================================
        document.getElementById('authorize_button').onclick = () => {
            console.log('Clic en autorizar...');
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error('Error OAuth:', resp);
                    document.getElementById('auth-status').innerHTML = '‚ùå Error de autenticaci√≥n.';
                    showError(`Error OAuth: ${resp.error}`);
                    return;
                }
                document.getElementById('authorize_button').style.display = 'none';
                document.getElementById('signout_button').style.display = 'inline-block';
                document.getElementById('auth-status').innerHTML = '‚úÖ Autenticado.';
                console.log('‚úÖ Autenticaci√≥n exitosa, cargando datos...');
                await cargarYMostrarDatos();
            };
            tokenClient.requestAccessToken({ prompt: 'consent' });
        };

        document.getElementById('signout_button').onclick = () => {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken(null);
                document.getElementById('table-container').innerHTML = '';
                document.getElementById('signout_button').style.display = 'none';
                document.getElementById('authorize_button').style.display = 'inline-block';
                document.getElementById('auth-status').innerHTML = 'üîí Sesi√≥n cerrada.';
                document.getElementById('loading').style.display = 'none';
            }
        };

        // ============================================
        // üìä FUNCI√ìN PRINCIPAL
        // ============================================
        async function cargarYMostrarDatos() {
            const contenedor = document.getElementById('table-container');
            const loading = document.getElementById('loading');
            const debugDiv = document.getElementById('debug-info');

            debugDiv.style.display = 'none';
            loading.style.display = 'block';
            contenedor.innerHTML = '';

            try {
                console.log('Solicitando datos a Sheets API...');
                
                // ‚úÖ VERIFICA QUE TENEMOS TOKEN
                if (!gapi.client.getToken()) {
                    throw new Error('No hay token de acceso. Vuelve a autorizar.');
                }

                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: RANGO,
                });

                console.log('Respuesta recibida:', response);

                const filas = response.result.values;
                if (!filas || filas.length === 0) {
                    contenedor.innerHTML = '<p>No se encontraron datos en la hoja.</p>';
                    return;
                }

                // Resto del c√≥digo para generar la tabla...
                const COLUMNAS = {
                    CODIGO: 0, ARTICULO: 1, UNIDADES: 2, COMENTARIO: 3,
                    UBICACION: 4, PRECIO: 5, FRAGIL: 6, FOTO: 7,
                    FECHA: 8, HORA: 9, LATITUD: 10, LONGITUD: 11, VENTA: 12
                };

                let html = `<h3>Total de items: ${filas.length}</h3><table>...`; // Continuar con tu l√≥gica

                contenedor.innerHTML = html;
                console.log(`‚úÖ Datos cargados: ${filas.length} filas`);

            } catch (error) {
                console.error('Error detallado:', error);
                let mensaje = `‚ùå Error: ${error.message}`;
                if (error.status === 403) mensaje += '<br>Verifica que la hoja est√© compartida y las credenciales sean correctas.';
                if (error.status === 404) mensaje += '<br>SPREADSHEET_ID podr√≠a ser incorrecto.';
                showError(mensaje);
            } finally {
                loading.style.display = 'none';
            }
        }

        // ============================================
        // üèÅ INICIALIZAR
        // ============================================
        window.gapiLoaded = gapiLoaded;
        window.gisLoaded = gisLoaded;

        // Depuraci√≥n inicial
        console.log('P√°gina cargada. Esperando inicializaci√≥n de APIs...');
    </script>
</body>
</html>
