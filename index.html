<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Visualizado</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #2c3e50; color: white; position: sticky; top: 0; }
        img.thumbnail { max-width: 100px; max-height: 100px; border-radius: 5px; border: 1px solid #ddd; }
        .status { padding: 15px; border-radius: 5px; margin: 15px 0; }
        .loading { background: #e3f2fd; color: #1565c0; }
        .success { background: #e8f5e9; color: #2e7d32; border-left: 4px solid #4caf50; }
        .error { background: #ffebee; color: #c62828; border-left: 4px solid #f44336; }
        button { padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #2980b9; }
        .fragile { background-color: #fff3cd !important; }
        .search { margin: 15px 0; padding: 10px; width: 300px; border: 1px solid #ddd; border-radius: 5px; }
        .pagination { margin-top: 20px; }
        .pagination button { margin: 0 5px; padding: 5px 10px; background: #7f8c8d; }
        .pagination button.active { background: #3498db; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ INVENTARIO - Datos en Tiempo Real</h1>
        <p>Mostrando datos directamente desde Google Sheets</p>
        
        <div id="status" class="status loading">
            ‚è≥ Inicializando sistema...
        </div>
        
        <div id="controls" style="display:none;">
            <div style="margin: 15px 0;">
                <input type="text" id="search" class="search" placeholder="üîç Buscar por art√≠culo, c√≥digo o ubicaci√≥n..." onkeyup="filterTable()">
                <button onclick="loadData()" style="background:#27ae60;">üîÑ Actualizar Datos</button>
            </div>
            <div id="summary"></div>
        </div>
        
        <div id="table-container"></div>
        <div id="pagination" class="pagination"></div>
        
        <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
            <h3>üìã Informaci√≥n del Sistema</h3>
            <p><strong>URL de GitHub Pages:</strong> <code>https://richard156.github.io/inventario/</code></p>
            <p><strong>ID de Hoja:</strong> <code>14Biamc2q1cvNegVz4pj0yfspWOoA1rf4</code></p>
            <p><strong>Hoja:</strong> <code>Data</code> | <strong>Rango:</strong> <code>A2:M</code></p>
            <p><strong>Carpeta de im√°genes:</strong> <code>scanpet/PHOTOS_salida_20260123_1452/</code></p>
        </div>
    </div>

    <script>
        // ============================================
        // üîß CONFIGURACI√ìN - ¬°REEMPLAZA ESTO!
        // ============================================
        const CONFIG = {
            // ‚ùó PASO 1: Obt√©n una NUEVA API_KEY en:
            // https://console.cloud.google.com/apis/credentials
            API_KEY: 'AIzaSyDwR2gcdFzYC3Lbt_o6kUtjQ9lN8dutnog'
            
            // ‚ùó PASO 2: Configura RESTRICCIONES para esa clave:
            // 1. Restricciones de API: "Google Sheets API"
            // 2. Restricciones HTTP: https://richard156.github.io
            
            // ID de tu Google Sheet (ya lo tienes)
            SPREADSHEET_ID: '14Biamc2q1cvNegVz4pj0yfspWOoA1rf4',
            
            // Nombre de la hoja y rango
            HOJA: 'Data',
            RANGO: 'A2:M',
            
            // URL base para im√°genes en GitHub
            IMAGENES_BASE: 'scanpet/PHOTOS_salida_20260123_1452/',
            
            // Paginaci√≥n
            ITEMS_POR_PAGINA: 20
        };

        // Variables globales
        let todosLosDatos = [];
        let paginaActual = 1;
        let datosFiltrados = [];

        // ============================================
        // üöÄ FUNCIONES PRINCIPALES
        // ============================================

        function actualizarEstado(mensaje, tipo = 'loading') {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = mensaje;
            statusEl.className = `status ${tipo}`;
            console.log(`Estado: ${mensaje}`);
        }

        function mostrarError(mensaje, error = null) {
            let html = `‚ùå <strong>${mensaje}</strong>`;
            
            if (error) {
                console.error('Error detallado:', error);
                
                if (error.message.includes('API key')) {
                    html += `<br><br><strong>SOLUCI√ìN:</strong><br>
                    1. Ve a <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a><br>
                    2. Crea una NUEVA "API Key"<br>
                    3. Configura restricciones:<br>
                       &nbsp;&nbsp;‚Ä¢ API: "Google Sheets API"<br>
                       &nbsp;&nbsp;‚Ä¢ HTTP: https://richard156.github.io<br>
                    4. Pega la clave completa arriba en CONFIG.API_KEY`;
                } else if (error.status === 403) {
                    html += `<br><br><strong>SOLUCI√ìN:</strong><br>
                    1. Abre tu Google Sheet<br>
                    2. Haz clic en "Compartir" (bot√≥n azul arriba)<br>
                    3. Cambia a "Cualquier persona con el enlace"<br>
                    4. Permisos: "Lector"`;
                } else if (error.status === 404) {
                    html += `<br><br>Verifica que:<br>
                    1. El ID de la hoja sea correcto<br>
                    2. La hoja se llame "Data" (exactamente as√≠)<br>
                    3. Hay datos en el rango A2:M`;
                }
            }
            
            actualizarEstado(html, 'error');
            document.getElementById('controls').style.display = 'none';
        }

        async function loadData() {
            // Validar API_KEY
            if (!CONFIG.API_KEY || CONFIG.API_KEY.length < 30) {
                mostrarError('API_KEY no configurada o inv√°lida. Sigue las instrucciones abajo.');
                return;
            }

            actualizarEstado('‚è≥ Conectando con Google Sheets...', 'loading');
            document.getElementById('controls').style.display = 'none';
            document.getElementById('table-container').innerHTML = '';

            try {
                // Construir URL de la API
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SPREADSHEET_ID}/values/${CONFIG.HOJA}!${CONFIG.RANGO}?key=${CONFIG.API_KEY}`;
                
                console.log('Solicitando datos desde:', url);

                // Hacer la petici√≥n
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw {
                        message: errorData.error?.message || `Error ${response.status}`,
                        status: response.status
                    };
                }

                const data = await response.json();
                
                if (!data.values || data.values.length === 0) {
                    actualizarEstado('‚úÖ Conexi√≥n exitosa, pero no hay datos en la hoja.', 'success');
                    return;
                }

                // Procesar datos
                todosLosDatos = procesarDatos(data.values);
                datosFiltrados = [...todosLosDatos];
                
                // Mostrar controles
                document.getElementById('controls').style.display = 'block';
                
                // Actualizar resumen
                actualizarResumen();
                
                // Mostrar datos
                renderTable();
                
                actualizarEstado(`‚úÖ ${todosLosDatos.length} items cargados correctamente`, 'success');

            } catch (error) {
                mostrarError(`Error al cargar datos: ${error.message}`, error);
            }
        }

        function procesarDatos(filas) {
            return filas.map((fila, index) => {
                // Mapear columnas seg√∫n tu estructura
                return {
                    id: index + 1,
                    codigo: fila[0] || '',
                    articulo: fila[1] || '',
                    unidades: fila[2] || '1',
                    comentario: fila[3] || '',
                    ubicacion: fila[4] || '',
                    precio: fila[5] || '0',
                    fragil: (fila[6] || '').toUpperCase() === 'SI',
                    foto: fila[7] || '',
                    fecha: fila[8] || '',
                    hora: fila[9] || '',
                    latitud: fila[10] || '',
                    longitud: fila[11] || '',
                    venta: fila[12] || ''
                };
            });
        }

        function actualizarResumen() {
            const summary = document.getElementById('summary');
            const fragiles = todosLosDatos.filter(item => item.fragil).length;
            const totalValor = todosLosDatos.reduce((sum, item) => {
                const precio = parseFloat(item.precio.replace(',', '.')) || 0;
                const unidades = parseInt(item.unidades) || 1;
                return sum + (precio * unidades);
            }, 0);
            
            summary.innerHTML = `
                <div class="success">
                    üìä <strong>Resumen del Inventario</strong><br>
                    ‚Ä¢ Total items: ${todosLosDatos.length}<br>
                    ‚Ä¢ Items fr√°giles: ${fragiles}<br>
                    ‚Ä¢ Valor total estimado: $${totalValor.toLocaleString('es-ES', {minimumFractionDigits: 2})}<br>
                    ‚Ä¢ √öltima actualizaci√≥n: ${new Date().toLocaleTimeString()}
                </div>
            `;
        }

        function renderTable() {
            const container = document.getElementById('table-container');
            const inicio = (paginaActual - 1) * CONFIG.ITEMS_POR_PAGINA;
            const fin = inicio + CONFIG.ITEMS_POR_PAGINA;
            const datosPagina = datosFiltrados.slice(inicio, fin);

            if (datosPagina.length === 0) {
                container.innerHTML = '<div class="error">No hay datos que coincidan con la b√∫squeda.</div>';
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            // Construir tabla
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>C√≥digo</th>
                            <th>Art√≠culo</th>
                            <th>Unid.</th>
                            <th>Ubicaci√≥n</th>
                            <th>Precio</th>
                            <th>Fr√°gil</th>
                            <th>Foto</th>
                            <th>Fecha</th>
                            <th>Comentario</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            datosPagina.forEach(item => {
                const urlFoto = item.foto ? `${CONFIG.IMAGENES_BASE}${item.foto}` : '';
                const claseFragil = item.fragil ? 'fragile' : '';
                
                html += `
                    <tr class="${claseFragil}">
                        <td>${item.id}</td>
                        <td><code>${item.codigo}</code></td>
                        <td><strong>${item.articulo}</strong></td>
                        <td>${item.unidades}</td>
                        <td>${item.ubicacion}</td>
                        <td>${formatearPrecio(item.precio)}</td>
                        <td>${item.fragil ? '‚úÖ S√≠' : '‚ùå No'}</td>
                        <td>
                            ${urlFoto ? `
                                <img src="${urlFoto}" 
                                     alt="${item.articulo}" 
                                     class="thumbnail"
                                     onerror="this.onerror=null; this.src='https://via.placeholder.com/100x100/cccccc/969696?text=Imagen+no+disponible';"
                                     loading="lazy">
                            ` : '‚Äî'}
                        </td>
                        <td>${item.fecha}</td>
                        <td>${item.comentario || '‚Äî'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            // Actualizar paginaci√≥n
            actualizarPaginacion();
        }

        function filterTable() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            
            if (!searchTerm) {
                datosFiltrados = [...todosLosDatos];
            } else {
                datosFiltrados = todosLosDatos.filter(item => 
                    item.codigo.toLowerCase().includes(searchTerm) ||
                    item.articulo.toLowerCase().includes(searchTerm) ||
                    item.ubicacion.toLowerCase().includes(searchTerm) ||
                    item.comentario.toLowerCase().includes(searchTerm)
                );
            }
            
            paginaActual = 1;
            renderTable();
            actualizarResumen();
        }

        function actualizarPaginacion() {
            const totalPaginas = Math.ceil(datosFiltrados.length / CONFIG.ITEMS_POR_PAGINA);
            const paginationEl = document.getElementById('pagination');
            
            if (totalPaginas <= 1) {
                paginationEl.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Bot√≥n anterior
            html += `<button onclick="cambiarPagina(${paginaActual - 1})" ${paginaActual === 1 ? 'disabled' : ''}>‚óÄ Anterior</button>`;
            
            // P√°ginas
            for (let i = 1; i <= totalPaginas; i++) {
                if (i === paginaActual) {
                    html += `<button class="active">${i}</button>`;
                } else if (i <= 3 || i > totalPaginas - 3 || Math.abs(i - paginaActual) <= 2) {
                    html += `<button onclick="cambiarPagina(${i})">${i}</button>`;
                } else if (i === 4 || i === totalPaginas - 3) {
                    html += `<span>...</span>`;
                }
            }
            
            // Bot√≥n siguiente
            html += `<button onclick="cambiarPagina(${paginaActual + 1})" ${paginaActual === totalPaginas ? 'disabled' : ''}>Siguiente ‚ñ∂</button>`;
            
            paginationEl.innerHTML = html;
        }

        function cambiarPagina(nuevaPagina) {
            const totalPaginas = Math.ceil(datosFiltrados.length / CONFIG.ITEMS_POR_PAGINA);
            
            if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas) {
                paginaActual = nuevaPagina;
                renderTable();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function formatearPrecio(valor) {
            if (!valor) return '‚Äî';
            const numero = parseFloat(valor.toString().replace(',', '.'));
            return isNaN(numero) ? valor : `$${numero.toLocaleString('es-ES', {minimumFractionDigits: 2})}`;
        }

        // ============================================
        // üèÅ INICIALIZACI√ìN
        // ============================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== INICIALIZANDO SISTEMA ===');
            console.log('Configuraci√≥n actual:', CONFIG);
            
            // Verificar configuraci√≥n inicial
            if (!CONFIG.API_KEY || CONFIG.API_KEY.length < 30) {
                mostrarError(`
                    <strong>‚ö†Ô∏è API_KEY NO CONFIGURADA</strong><br><br>
                    <strong>PASOS INMEDIATOS:</strong><br>
                    1. Haz clic en este enlace: <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a><br>
                    2. Crea una NUEVA "API Key"<br>
                    3. Configura RESTRICCIONES:<br>
                       &nbsp;&nbsp;‚Ä¢ <strong>Restricciones de API</strong>: "Google Sheets API"<br>
                       &nbsp;&nbsp;‚Ä¢ <strong>Restricciones HTTP</strong>: https://richard156.github.io<br>
                    4. Copia la clave COMPLETA (40 caracteres)<br>
                    5. P√©gala aqu√≠: <code>CONFIG.API_KEY = 'TU_CLAVE_AQUI';</code><br><br>
                    <button onclick="loadData()" style="background:#e74c3c; color:white; padding:10px; border:none; border-radius:5px; margin-top:10px;">
                        üöÄ Intentar de nuevo despu√©s de configurar
                    </button>
                `);
            } else {
                // Cargar datos autom√°ticamente si hay API_KEY
                loadData();
            }
        });

        // Hacer funciones globales para los eventos HTML
        window.loadData = loadData;
        window.filterTable = filterTable;
        window.cambiarPagina = cambiarPagina;
    </script>
</body>
</html>
